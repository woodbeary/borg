rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /definitions/{definitionId} {
      // Anyone can read definitions
      allow read: if true;
      
      // Allow vote updates from regular users
      allow update: if 
        // Only allow updating the votes field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['votes']) &&
        // Only allow incrementing or decrementing by 1
        math.abs(request.resource.data.votes - resource.data.votes) == 1;
      
      // Allow all operations for admin
      allow write: if request.auth != null && request.auth.token.admin == true;
      
      // Only allow creates through server-side admin SDK
      allow create: if false;
    }
    
    // Default to denying all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 